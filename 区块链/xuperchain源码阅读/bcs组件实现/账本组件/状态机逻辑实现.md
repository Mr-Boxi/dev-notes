## 状态机逻辑实现   
目录：  
 
状态机运行上下文   
state
utxo  
xmodel  


**type StateCtx struct**
```
// 状态机运行上下文环境
type StateCtx struct {
	// 基础上下文
	xctx.BaseCtx
	// 运行环境配置
	EnvCfg *xconf.EnvConf
	// 账本配置
	LedgerCfg *lconf.XLedgerConf
	// 链名
	BCName string
	// ledger handle
	Ledger *ledger.Ledger
	// crypto client
	Crypt cryptoBase.CryptoClient
	// acl manager
	// 注意：注入后才可以使用
	AclMgr aclBase.AclManager
	// contract Manager
	// 注意：依赖注入后才可以使用
	ContractMgr contract.Manager
	// 注意：注入后才可以使用
	GovernTokenMgr governToken.GovManager
	// 注意：注入后才可以使用
	ProposalMgr propose.ProposeManager
	// 注意：注入后才可以使用
	TimerTaskMgr timerTask.TimerManager
} 
```
- func NewStateCtx(envCfg *xconf.EnvConf, bcName string, leg *ledger.Ledger, crypt cryptoBase.CryptoClient) (*StateCtx, error)
- func (t *StateCtx) SetAclMG(aclMgr aclBase.AclManager)
- func (t *StateCtx) SetContractMG(contractMgr contract.Manager)  
- func (t *StateCtx) SetGovernTokenMG(governTokenMgr governToken.GovManager) 
- func (t *StateCtx) SetProposalMG(proposalMgr propose.ProposeManager) 
- func (t *StateCtx) SetTimerTaskMG(timerTaskMgr timerTask.TimerManager)  
- func (t *StateCtx) IsInit() bool  

**type State struct**
```
 type State struct {
 	// 状态机运行环境上下文
 	sctx          *context.StateCtx
 	log           logs.Logger
 	utxo          *utxo.UtxoVM   //utxo表
 	xmodel        *xmodel.XModel //xmodel数据表和历史表
 	meta          *meta.Meta     //meta表
 	tx            *tx.Tx         //未确认交易表
 	ldb           kvdb.Database
 	latestBlockid []byte
 
 	// 最新区块高度通知装置
 	heightNotifier *BlockHeightNotifier
 }
```
- func NewState(sctx *context.StateCtx) (*State, error) //创建状态机实例  
- func (t *State) SetAclMG(aclMgr aclBase.AclManager) 
- func (t *State) SetContractMG(contractMgr contract.Manager)
- func (t *State) SetGovernTokenMG(governTokenMgr governToken.GovManager)  
- func (t *State) SetProposalMG(proposalMgr propose.ProposeManager)  
- func (t *State) SetTimerTaskMG(timerTaskMgr timerTask.TimerManager)
 
- func (t *State) SelectUtxos(fromAddr string, totalNeed *big.Int, needLock, excludeUnconfirmed bool) ([]*protos.TxInput, [][]byte, *big.Int, error)
- 

**type Meta struct**
```
 type Meta struct {
 	log       logs.Logger
 	Ledger    *ledger.Ledger
 	Meta      *pb.UtxoMeta  // utxo meta
 	MetaTmp   *pb.UtxoMeta  // tmp utxo meta
 	MutexMeta *sync.Mutex   // access control for meta
 	MetaTable kvdb.Database // 元数据表，会持久化保存latestBlockid
 }
```
- func NewMeta(sctx *context.StateCtx, stateDB kvdb.Database) (*Meta, error)
- func (t *Meta) GetNewAccountResourceAmount() int64
- func (t *Meta) LoadNewAccountResourceAmount() (int64, error) 
- func (t *Meta) UpdateNewAccountResourceAmount(newAccountResourceAmount int64, batch kvdb.Batch) error 
- func (t *Meta) GetMaxBlockSize() int64 
- func (t *Meta) LoadMaxBlockSize() (int64, error) 
- func (t *Meta) MaxTxSizePerBlock() (int, error) 
- func (t *Meta) UpdateMaxBlockSize(maxBlockSize int64, batch kvdb.Batch) error 
- func (t *Meta) GetReservedContracts() []*protos.InvokeRequest 
- 
-
- 

**type UtxoVM struct**
``` 
type UtxoVM struct {
	metaHandle        *meta.Meta
	ldb               kvdb.Database
	Mutex             *sync.RWMutex // utxo leveldb表读写锁
	MutexMem          *sync.Mutex   // 内存锁定状态互斥锁
	SpLock            *SpinLock     // 自旋锁,根据交易涉及的utxo和改写的变量
	mutexBalance      *sync.Mutex   // 余额Cache锁
	lockKeys          map[string]*UtxoLockItem
	lockKeyList       *list.List // 按锁定的先后顺序，方便过期清理
	lockExpireTime    int        // 临时锁定的最长时间
	UtxoCache         *UtxoCache
	log               logs.Logger
	ledger            *ledger.Ledger           // 引用的账本对象
	utxoTable         kvdb.Database            // utxo表
	OfflineTxChan     chan []*pb.Transaction   // 未确认tx的通知chan
	PrevFoundKeyCache *cache.LRUCache          // 上一次找到的可用utxo key，用于加速GenerateTx
	utxoTotal         *big.Int                 // 总资产
	cryptoClient      crypto_base.CryptoClient // 加密实例
	ModifyBlockAddr   string                   // 可修改区块链的监管地址
	BalanceCache      *cache.LRUCache          //余额cache,加速GetBalance查询
	CacheSize         int                      //记录构造utxo时传入的cachesize
	BalanceViewDirty  map[string]int           //balanceCache 标记dirty: addr -> sequence of view
	unconfirmTxInMem  *sync.Map                //未确认Tx表的内存镜像
	unconfirmTxAmount int64                    // 未确认的Tx数目，用于监控
	bcname            string
}
```
- func NewUtxo(sctx *context.StateCtx, metaHandle *meta.Meta, stateDB kvdb.Database) (*UtxoVM, error)
- 

**type UtxoCache struct**
```
 // UtxoCache is a in-memory cache of UTXO
 type UtxoCache struct {
 	// <ADDRESS, <UTXO_KEY, UTXO_ITEM>>
 	Available map[string]map[string]*CacheItem
 	All       map[string]map[string]*CacheItem
 	List      *list.List
 	Limit     int
 	mutex     *sync.Mutex
 }
```

**type UtxoItem struct**   
```
 // UtxoItem the data structure of an UTXO item
 type UtxoItem struct {
 	Amount       *big.Int //utxo的面值
 	FrozenHeight int64    //锁定until账本高度超过
 }

```
- func (item *UtxoItem) Loads(data []byte) error 
- func (item *UtxoItem) Dumps() ([]byte, error)

**type UTXOSandbox struct**
```
type UTXOSandbox struct {
	inputCache  []*protos.TxInput
	outputCache []*protos.TxOutput
	utxoReader  contract.UtxoReader
} 
```
- func NewUTXOSandbox(cfg *contract.SandboxConfig) *UTXOSandbox 
- func (u *UTXOSandbox) Transfer(from, to string, amount *big.Int) error 
- func (uc *UTXOSandbox) GetUTXORWSets() *contract.UTXORWSet 

---
xumodel 模型

**type XModel struct**
```
// XModel xmodel data structure
type XModel struct {
	ledger          *ledger.Ledger
	stateDB         kvdb.Database
	unconfirmTable  kvdb.Database
	extUtxoTable    kvdb.Database
	extUtxoDelTable kvdb.Database
	logger          logs.Logger
	batchCache      *sync.Map
	lastBatch       kvdb.Batch
	// extUtxoCache caches per bucket key-values using version as key
	extUtxoCache sync.Map // map[string]*LRUCache
} 
```

state 状态机

 

**type BlockAgent struct**
``` 
type BlockAgent struct {
	blk *lpb.InternalBlock
}
```
**type BlockHeightNotifier struct**
```
type BlockHeightNotifier struct {
	mutex  sync.Mutex
	cond   *sync.Cond
	height int64
} 
```