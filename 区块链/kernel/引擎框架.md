### 引擎框架  
xupercore/kernel/engines  

engine  // 引擎工厂方法(xuperos, xchain)  
xuperos  //面向公链应用场景设计的区块链执行引擎

---
- var  
    engineMu sync.RWMutex  
    engines  = make(map[string]NewBCEngineFunc)  
    
- type  
    type NewBCEngineFunc func() BCEngine  
    
- interface  
    type BCEngine interface  //引擎基础接口
    * Init(*xconf.EnvConf) error
    * Run()  
    * Exit()
    
- func  
    func CreateBCEngine(egName string, envCfg *xconf.EnvConf) (BCEngine, error)  
    func Register(name string, f NewBCEngineFunc)  //注册引擎创建函数
    func newBCEngine(name string) BCEngine  
   
#### xuperos实现    
/xupercore/kernel/engines/xuperos  
重点： 引擎，链， 链管理

- struct  
    type Engine struct  // xuperos执行引擎，为公链场景订制区块链引擎  
    * func NewEngine() engines.BCEngine  
    * func (t *Engine) Init(envCfg *xconf.EnvConf) error  
    * func (t *Engine) Run()  
    * func (t *Engine) Exit()   
    * func (t *Engine) Get(name string) (common.Chain, error) 
    * func (t *Engine) Stop(name string) error  
    * func (t *Engine) Context() *common.EngineCtx  
    * func (t *Engine) GetChains() []string  
    * func (t *Engine) loadChains() error  //本地加载  
    * func (t *Engine) createEngCtx(envCfg *xconf.EnvConf) (*common.EngineCtx, error)  
    * func (t *Engine) exit()   
    * func (t *Engine) LoadChain(name string) error    
    
    type Chain struct   // 定义一条链的具体行为  
    * func LoadChain(engCtx *common.EngineCtx, bcName string) (*Chain, error)  
    * func (t *Chain) Start()  //阻塞  
    * func (t *Chain) Stop()   
    * func (t *Chain) Context() *common.ChainCtx  
    * func (t *Chain) PreExec(ctx xctx.XContext, reqs []*protos.InvokeRequest, initiator string, authRequires []string) (*protos.InvokeResponse, error)  //交易预执行  
    * func (t *Chain) SubmitTx(ctx xctx.XContext, tx *lpb.Transaction) error  //提交交易到交易池(xuperos引擎同时更新到状态机和交易池)  
    * func (t *Chain) ProcBlock(ctx xctx.XContext, block *lpb.InternalBlock) error  //处理P2P网络同步到的区块  
    * func (t *Chain) initChainCtx() error   // 初始化链运行依赖上下文  
    * func (t *Chain) CreateParaChain() error   //创建平行链实例  
    
    type ChainManagerImpl struct  // 用于管理链操作  
    * func (m *ChainManagerImpl) Get(chainName string) (common.Chain, error)  
    * func (m *ChainManagerImpl) Put(chainName string, chain common.Chain)  
    * func (m *ChainManagerImpl) Stop(chainName string) error  
    * func (m *ChainManagerImpl) GetChains() []string  
    * func (m *ChainManagerImpl) StartChains()   
    * func (m *ChainManagerImpl) StopChains()   
    * func (m *ChainManagerImpl) LoadChain(chainName string) error    
    
- func  
    func init()  // 向工厂注册自己的创建引擎方法  
    func EngineConvert(engine engines.BCEngine) (common.Engine, error)  // 引擎转换  

- common 公共组件模块  
    type Chain interface  
    
    type Engine interface  //定义xuperos引擎对外暴露接口  
    
    type EngineRelyAgent interface  //定义引擎对各组件依赖接口约束  
    
    type ChainRelyAgent interface // 定义链对各组件依赖接口约束  
    
    type ChainManager interface  
    
    type AsyncworkerAgent interface  
    
    type TaskHandler func(ctx TaskContext) error  
    
    type TaskContext interface  
    
    -
    相关错误统一定义    
    type Error struct  
    
    -
    相关上下文定义  
    type EngineCtx struct  // 引擎运行上下文环境  
    
    type ChainCtx struct //链级别上下文，维护链级别上下文，每条平行链各有一个  
    
         
- config  配置模块  
    type EngineConf struct  
    * func (t *EngineConf) loadConf(cfgFile string) erro  
    
    func LoadEngineConf(cfgFile string) (*EngineConf, error)  
    func GetDefEngineConf() *EngineConf  
    
    
- agent 依赖代理模块  
    type ChainCoreAgent struct  
    * func NewChainCoreAgent(chainCtx *common.ChainCtx) *ChainCoreAgent  
    * func (t *ChainCoreAgent) GetAccountAddresses(accountName string) ([]string, error)  
    * func (t *ChainCoreAgent) VerifyContractPermission(initiator string, authRequire []string, contractName, methodName string) (bool, error)  //结合合约acl设置鉴权  
    * func (t *ChainCoreAgent) VerifyContractOwnerPermission(contractName string, authRequire []string) error  // 结合合约acl设置鉴权  
    * func (t *ChainCoreAgent) QueryTransaction(txid []byte) (*pb.Transaction, error)   
    * func (t *ChainCoreAgent) QueryBlock(blockid []byte) (ledger.BlockHandle, error)  
    
    type LedgerAgent struct  
    * func NewLedgerAgent(chainCtx *common.ChainCtx) *LedgerAgent   func (t *LedgerAgent) GetNewAccountGas() (int64, error)   
    * func (t *LedgerAgent) GetNewGovGas() (int64, error)   //从创世块获取治理代币消耗gas  
    * func (t *LedgerAgent) GetGenesisPreDistribution() ([]ledger.Predistribution, error)  
    * func (t *LedgerAgent) GetCryptoType() (string, error)  
    * func (t *LedgerAgent) GetConsensusConf() ([]byte, error)   //从创世块获取共识配置  
    * func (t *LedgerAgent) QueryBlock(blkId []byte) (kledger.BlockHandle, error)  
    * func (t *LedgerAgent) QueryBlockByHeight(height int64) (kledger.BlockHandle, error)   
    * func (t *LedgerAgent) GetTipBlock() kledger.BlockHandle  
    * func (t *LedgerAgent) GetTipXMSnapshotReader() (kledger.XMSnapshotReader, error)   
    * func (t *LedgerAgent) CreateSnapshot(blkId []byte) (kledger.XMReader, error)   
    * func (t *LedgerAgent) GetTipSnapshot() (kledger.XMReader, error)  
    * func (t *LedgerAgent) CreateXMReader() kledger.XMReader   
    
    type EngineRelyAgentImpl struct  //代理依赖组件实例化操作，方便mock单测和并行开发  
    
    type ChainRelyAgentImpl struct   //代理依赖组件实例化操作，方便mock单测和并行开发  
         
             
- asysnworker 模块(异步任务)    
    type AsyncWorker interface  
    * RegisterHandler(contract string, event string, handler func(ctx common.TaskContext) error)  
    
    type TaskContextImpl struct  
    * func newTaskContextImpl(buf []byte) *TaskContextImpl  
    * func (tc *TaskContextImpl) ParseArgs(v interface{}) error  
    * func (tc *TaskContextImpl) RetryTimes() int   
    
    type AsyncWorkerImpl struct 
    ```
      type 
    ``` 
    * func NewAsyncWorkerImpl(bcName string, e common.Engine, baseDB kvdb.Database) (*AsyncWorkerImpl, error)  
    * func (aw *AsyncWorkerImpl) RegisterHandler(contract string, event string, handler common.TaskHandler)   
    * func (aw *AsyncWorkerImpl) addBlockFilter(contract, event string)   
    * func (aw *AsyncWorkerImpl) Start() (err error)   
    * func (aw *AsyncWorkerImpl) doAsyncTasks(txs []*protos.FilteredTransaction, height int64, cursor *asyncWorkerCursor) error  
    * func (aw *AsyncWorkerImpl) storeCursor(cursor asyncWorkerCursor) error  
    * func (aw *AsyncWorkerImpl) reloadCursor() (*asyncWorkerCursor, error)   
    * func (aw *AsyncWorkerImpl) getAsyncTask(contract, event string) (common.TaskHandler, error)  
    * func (aw *AsyncWorkerImpl) Stop()  
    
    type asyncWorkerCursor struct  
    
  
- event  事件模块  
    type Topic interface  //Topic is the factory of event Iterato  
    type Iterator interface  
    type ChainManager interface  
    type BlockStore interface  
    type Router struct  
    
    type blockFilter struct  
    
    type filteredBlockIterator struct  
    
    type BlockTopic struct  
    

- miner  矿工模块  
    type Miner struct   //负责生产和同步区块 
    ```
    type Miner struct {
    	ctx *common.ChainCtx
    	log logs.Logger
    	// 矿工锁，用来确保矿工出块和同步操作串行进行
    	minerMutex sync.Mutex
    	// 矿工处理区块的队列
    	minerQueue int64
    	// 记录同步中任务目标区块高度
    	inSyncHeight       int64
    	inSyncTargetHeight int64
    	// 记录同步中任务目标区块id
    	inSyncTargetBlockId []byte
    	// 标记是否退出运行
    	isExit bool
    	// 用户等待退出
    	exitWG sync.WaitGroup
    }
    ``` 
    * func NewMiner(ctx *common.ChainCtx) *Miner  
    * func (t *Miner) ProcBlock(ctx xctx.XContext, block *lpb.InternalBlock) error  
    * func (t *Miner) Start()  
    * func (t *Miner)ReadTermTable(ctx xctx.XContext) (bool,error)  //读term表  
    * func (t *Miner)UpdateCacheTable(ctx xctx.XContext)  
    * func (t *Miner) Stop()  
    * func (t *Miner) IsExit() bool   
    * func (t *Miner) mining(ctx xctx.XContext,flag bool) error  
    * func (t *Miner) truncateForMiner(ctx xctx.XContext, target []byte) error  
    * func (t *Miner) packBlock(ctx xctx.XContext, height int64,
      	now time.Time, consData []byte,flag bool) (*lpb.InternalBlock, error)   
    * func (t *Miner) convertConsData(data []byte) (*state.ConsensusStorage, error)   
    * func (t *Miner) getTimerTx(height int64) (*lpb.Transaction, error)   
    * func (t *Miner) getUnconfirmedTx(sizeLimit int) ([]*lpb.Transaction, error)   
    * func (t *Miner) getAwardTx(height int64,flag bool) (*lpb.Transaction, *big.Int,error)   
    * func (t * Miner)GetThawTx(height int64,ctx xctx.XContext)([]*lpb.Transaction, error)  
    * func (t * Miner)ClearThawTx(height int64,ctx xctx.XContext)error  
    * func (t *Miner) confirmBlockForMiner(ctx xctx.XContext, block *lpb.InternalBlock) error  
    * func (t *Miner) trySyncBlock(ctx xctx.XContext, targetBlock *lpb.InternalBlock) error   
    * func (t *Miner) syncBlock(ctx xctx.XContext, targetBlock *lpb.InternalBlock) error  
    * func (t *Miner) downloadMissBlock(ctx xctx.XContext, targetBlock *lpb.InternalBlock)([][]byte, error)  
    * func (t *Miner) getBlock(ctx xctx.XContext, blockId []byte) (*lpb.InternalBlock, error)   
    * func (t *Miner) batchConfirmBlock(ctx xctx.XContext, blkIds [][]byte) error   
    * func (t *Miner) isConfirmed(ctx xctx.XContext, bcs *xpb.ChainStatus) bool  
    * func (t *Miner) broadcastBlock(ctx xctx.XContext, block *lpb.InternalBlock)   
    * func (t *Miner) getWholeNetLongestBlock(ctx xctx.XContext) (*lpb.InternalBlock, error)   
    
    type BCSByHeight []*xpb.ChainStatus  
    * func (s BCSByHeight) Len() int   
    * func (s BCSByHeight) Less(i, j int) bool  
    * func (s BCSByHeight) Swap(i, j int)   
    
- net  net_event模块  
    type NetEvent struct  
    * func NewNetEvent(engine common.Engine) (*NetEvent, error)  
    * func (t *NetEvent) Start()   
    * func (t *NetEvent) Stop()  
    * func (t *NetEvent) Subscriber() error  
    * func (t *NetEvent) procMsgLoop()  
    * func (t *NetEvent) procAsyncMsg(request *protos.XuperMessage)  
    * func (t *NetEvent) handleBatchPostTx(ctx xctx.XContext, request *protos.XuperMessage)   
    * func (t *NetEvent) PostTx(ctx xctx.XContext, chain common.Chain, tx *lpb.Transaction) error   
    * func (t *NetEvent) handleSendBlock(ctx xctx.XContext, request *protos.XuperMessage)   
    * func (t *NetEvent) handleNewBlockID(ctx xctx.XContext, request *protos.XuperMessage)  
    * func (t *NetEvent) SendBlock(ctx xctx.XContext, chain common.Chain, in *lpb.InternalBlock) error  
    * func (t *NetEvent) handleGetBlock(ctx xctx.XContext,
      	request *protos.XuperMessage) (*protos.XuperMessage, error)   
    * func (t *NetEvent) handleGetChainStatus(ctx xctx.XContext, request *protos.XuperMessage) (*protos.XuperMessage, error)  
    * func (t *NetEvent) handleConfirmChainStatus(ctx xctx.XContext, request *protos.XuperMessage) (*protos.XuperMessage, error)  
    * func (t *NetEvent) GetBlock(ctx xctx.XContext, request *protos.XuperMessage) (*lpb.InternalBlock, error)   
    
    
- parachain    
    type Manager struct  
    * func NewParaChainManager(ctx *ParaChainCtx) (*Manager, error)  
     
    type ParaChainCtx struct  
    * func NewParaChainCtx(bcName string, cctx *common.ChainCtx) (*ParaChainCtx, error)   
    
    type paraChainContract struct   
    * func NewParaChainContract(bcName string, minNewChainAmount int64, chainCtx *common.ChainCtx) *paraChainContract  
    * func (p *paraChainContract) handleCreateChain(ctx common.TaskContext) error  
    * func (p *paraChainContract) doCreateChain(bcName string, bcGenesisConfig string) error  
    * func (p *paraChainContract) handleStopChain(ctx common.TaskContext) error  
    * func (p *paraChainContract) doStopChain(bcName string) error   
    * func (p *paraChainContract) handleRefreshChain(ctx common.TaskContext) error  
    * func (p *paraChainContract) createChain(ctx contract.KContext) (*contract.Response, error)  
    * func (p *paraChainContract) stopChain(ctx contract.KContext) (*contract.Response, error)   
    * func (p *paraChainContract) parseArgs(args map[string][]byte) (string, string, *Group, error)  
    * func (p *paraChainContract) editGroup(ctx contract.KContext) (*contract.Response, error)  
    * func (p *paraChainContract) getGroup(ctx contract.KContext) (*contract.Response, error)   
    
    func loadConfig(fname string) (*ParaChainConfig, error)  
    func loadGroupArgs(args map[string][]byte, group *Group) (*Group, error)  
    func isContain(items []string, item string) bool   
    func newContractErrResponse(status int, msg string) *contract.Response   
    
       
- reader  对外暴露读能力  
    type ChainReader interface  //链  
    type ConsensusReader interface   //共识  
    type ContractReader interface  //合约  
    type LedgerReader interface  //账本  
    type UtxoReader interface  //utxo  
    
    type chainReader struct  
    type consensusReader struct  
    type contractReader struct  
    type ledgerReader struct  
    type utxoReader struct  
    

- xpb  
    
        
 